# Interrupt

CPU 获知计算机中发生的某些事，CPU 暂停正在执行的程序，转而去执行处理该事件的程
序，当这段程序执行完毕后，CPU 继续执行刚才的程序。整个过程称为“中断处理”，也称
为“中断”。

## 中断分类

- 外中断
    - 可屏蔽中断
    - 非可屏蔽中断
- 内中断
    - 软中断
    - 异常

## 内中断

内中断产生于 CPU 和软件内部，与外部硬件无关。

### 软中断

软中断是由软件主动发起的中断，可以认为是一种应用程序和操作系统沟通的方式。例如
读写磁盘，应用程序运行在较低特权级，无权访问磁盘，需要操作系统代劳，于是调用系
统调用，也就是中断来完成。

### 异常

异常是指令执行期间 CPU 内部产生的错误引起的。这些错误会影响 CPU 正常运行，因此
不受 `eflags` 中的 `IF` 位影响。

异常按轻重程度可以分为三种：

- 故障（Fault）：最轻的一种，是可以被修复的，比如缺页异常（Page Fault）
- 陷阱（Trap）：通常用于调试
- 终止（Abort）：最严重的异常，无法修复，程序无法继续执行

#### 异常列表

| 编号              | 名称           | 类型      | 助记符  | 错误码    |
| ----------------- | -------------- | --------- | ------- | --------- |
| 0 (0x0)           | 除零错误       | 故障      | #DE     | 无        |
| 1 (0x1)           | 调试           | 故障/陷阱 | #DB     | 无        |
| 2 (0x2)           | 不可屏蔽中断   | 中断      | -       | 无        |
| 3 (0x3)           | 断点           | 陷阱      | #BP     | 无        |
| 4 (0x4)           | 溢出           | 陷阱      | #OF     | 无        |
| 5 (0x5)           | 越界           | 故障      | #BR     | 无        |
| 6 (0x6)           | 指令无效       | 故障      | #UD     | 无        |
| 7 (0x7)           | 设备不可用     | 故障      | #NM     | 无        |
| 8 (0x8)           | 双重错误       | 终止      | #DF     | 有 (Zero) |
| 9 (0x9)           | 协处理器段超限 | 故障      | -       | 无        |
| 10 (0xA)          | 无效任务状态段 | 故障      | #TS     | 有        |
| 11 (0xB)          | 段无效         | 故障      | #NP     | 有        |
| 12 (0xC)          | 栈段错误       | 故障      | #SS     | 有        |
| 13 (0xD)          | 一般性保护异常 | 故障      | #GP     | 有        |
| 14 (0xE)          | 缺页错误       | 故障      | #PF     | 有        |
| 15 (0xF)          | 保留           | -         | -       | 无        |
| 16 (0x10)         | 浮点异常       | 故障      | #MF     | 无        |
| 17 (0x11)         | 对齐检测       | 故障      | #AC     | 有        |
| 18 (0x12)         | 机器检测       | 终止      | #MC     | 无        |
| 19 (0x13)         | SIMD 浮点异常  | 故障      | #XM/#XF | 无        |
| 20 (0x14)         | 虚拟化异常     | 故障      | #VE     | 无        |
| 21 (0x15)         | 控制保护异常   | 故障      | #CP     | 有        |
| 22-31 (0x16-0x1f) | 保留           | -         | -       | 无        |

说明：

0. 当进行除以零的操作时产生
1. 当进行程序单步跟踪调试时，设置了标志寄存器 eflags 的 T 标志时产生这个中断
2. 由不可屏蔽中断 NMI 产生
3. 由断点指令 int3 产生，与 debug 处理相同
4. eflags 的溢出标志 OF 引起
5. 寻址到有效地址以外时引起
6. CPU 执行时发现一个无效的指令操作码
7. 设备不存在，指协处理器，在两种情况下会产生该中断：
    1. CPU 遇到一个转意指令并且 EM 置位时，在这种情况下处理程序应该模拟导致异常
       的指令
    2. MP 和 TS 都在置位状态时，CPU 遇到 WAIT 或一个转移指令。在这种情况下，处
       理程序在必要时应该更新协处理器的状态
8. 双故障出错
9.  协处理器段超出，只有 386 会产生此异常
10. CPU 切换时发觉 TSS 无效
11. 描述符所指的段不存在
12. 堆栈段不存在或寻址堆栈段越界
13. 没有符合保护机制（特权级）的操作引起
14. 页不在内存或不存在
15. 保留
16. 协处理器发出的出错信号引起
17. 对齐检测只在 CPL 3 执行，于 486 引入
18. 与模型相关，于奔腾处理器引入
19. 与浮点操作相关，于奔腾 3 引入
20. 只在可以设置 EPT - violation 的处理器上产生
21. ret, iret 等指令可能会产生该异常

## 中断描述符表

中断描述符表（Interrupt Descriptor Table，IDT）是保护模式下用于存储中断处理程序
的表。与实模式下的中断向量表类似，描述符记录了中断向量程序的位置及一些属性。

因为 CPU 只支持 256 个中断，所以 IDT 长度为 256。而且 IDT 的第 0 个描述符可以被
使用，它是**除零错误**。

### 中断描述符寄存器

与 GDT 类似，CPU 会从中断描述符寄存器（IDTR）寻找 IDT，也有专门的指令加载，保存
IDT。

```asm
lidt ptr
sidt ptr
```

IDTR 的结构：

```language
|47                 16 |15            0|
| 32 bits base address | 16 bits limit |
```

### 门描述符

中断描述符也称为**门描述符**。除了有中断门，还有任务门，陷阱门等。

中断门会自动将 `eflags` 中的 `IF` 位置 0，表示不允许中断，以此避免中断嵌套。而
任务门和陷阱门都不会。

门描述符的结构与全局描述符类似。

```language
|63            48|47|46 45|44|43 40|39    32|
|Offset          |P |DPL  |S |Type |Reserved|

|31            16|15                       0|
|Segment Selector|Offset                    |
```

- P：Present bit。必须为 1，表示该段有效。
- S：Segment type。必须为 0，表示系统段。
- Type：确定门的类型
    - 0b0110：16 位中断门
    - 0b1110：32 位中断门

